/**
 * Main JavaScript for INTEB Chat module
 *
 * @module     mod_intebchat/lib
 * @copyright  2025 Alonso Arias <soporte@ingeweb.co>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_intebchat/lib",["jquery","core/ajax","core/str","core/notification"],(function($,Ajax,Str,Notification){var questionString="Ask a question...",errorString="An error occurred! Please try again later.",chatData={},tokenInfo={enabled:!1,limit:0,used:0,exceeded:!1,resetTime:0},updateTokenUI=function(){if(tokenInfo.enabled){var $container=$(".mod_intebchat"),$input=$container.find("#openai_input"),$submitBtn=$container.find("#go"),$progressBar=$container.find(".progress-bar");if(tokenInfo.exceeded?($input.prop("disabled",!0),$submitBtn.prop("disabled",!0)):($input.prop("disabled",!1),$submitBtn.prop("disabled",!1)),$progressBar.length){var percentage=tokenInfo.used/tokenInfo.limit*100;$progressBar.css("width",percentage+"%"),percentage>90?$progressBar.css("background","linear-gradient(135deg, #e53e3e 0%, #c53030 100%)"):percentage>75&&$progressBar.css("background","linear-gradient(135deg, #dd6b20 0%, #c05621 100%)")}}},checkTokenReset=function(){var now=Date.now()/1e3;tokenInfo.exceeded&&now>tokenInfo.resetTime&&window.location.reload()},addToChatLog=function(type,message,instanceId){var messageContainer=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log'),messageElem=$("<div></div>").addClass("openai_message").addClass(type),messageText=$("<span></span>").html(message);messageElem.append(messageText);var timestamp=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),timestampElem=$("<span></span>").addClass("message-timestamp").text(timestamp);messageElem.append(timestampElem),messageContainer.append(messageElem),messageContainer.animate({scrollTop:messageContainer[0].scrollHeight},300)},clearHistory=function(instanceId){(chatData=localStorage.getItem("mod_intebchat_data"))&&(chatData=JSON.parse(chatData))[instanceId]&&(chatData[instanceId]={},localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').html("")},createCompletion=function(message,instanceId,api_type){var threadId=null;"assistant"===api_type&&((chatData=localStorage.getItem("mod_intebchat_data"))?(chatData=JSON.parse(chatData))[instanceId]&&(threadId=chatData[instanceId].threadId||null):chatData={[instanceId]:{}});var history=buildTranscript(instanceId);$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').addClass("disabled"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').removeClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",questionString),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').blur(),addToChatLog("bot loading","...",instanceId),$.ajax({url:M.cfg.wwwroot+"/mod/intebchat/api/completion.php",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({message:message,history:history,instanceId:instanceId,threadId:threadId}),success:function(data){$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').children().last().remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled"),data.message?(addToChatLog("bot",data.message,instanceId),data.thread_id&&(chatData[instanceId].threadId=data.thread_id,localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))),data.tokenInfo&&tokenInfo.enabled&&(tokenInfo.used+=data.tokenInfo.total||0,updateTokenUI(),tokenInfo.used>=tokenInfo.limit&&(tokenInfo.exceeded=!0,updateTokenUI(),Notification.addNotification({message:M.util.get_string("tokenlimitexceeded","mod_intebchat"),type:"error"})))):data.error&&("token_limit_exceeded"===data.error.type?(tokenInfo.exceeded=!0,updateTokenUI(),Notification.addNotification({message:data.error.message,type:"error"})):addToChatLog("bot error",data.error.message,instanceId)),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').focus()},error:function(xhr,status,error){$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').children().last().remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled");var errorMsg=errorString;try{var response=JSON.parse(xhr.responseText);response.error&&(errorMsg=response.error)}catch(e){}addToChatLog("bot error",errorMsg,instanceId),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').addClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",errorString)}})},buildTranscript=function(instanceId){var transcript=[];return $('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').each((function(index,element){if(index!==$('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').length-1){var user=userName;$(element).hasClass("bot")&&(user=assistantName);var messageText=$(element).clone();messageText.find(".message-timestamp").remove(),transcript.push({user:user,message:messageText.text().trim()})}})),transcript};return{init:function(data){var instanceId=data.instanceId,api_type=data.api_type,persistConvo=data.persistConvo;tokenInfo.enabled=data.tokenLimitEnabled||!1,tokenInfo.limit=data.tokenLimit||0,tokenInfo.used=data.tokensUsed||0,tokenInfo.exceeded=data.tokenLimitExceeded||!1,tokenInfo.resetTime=data.resetTime||0,"assistant"===api_type&&((chatData=localStorage.getItem("mod_intebchat_data"))?(chatData=JSON.parse(chatData))[instanceId]&&chatData[instanceId].threadId&&"1"===persistConvo?$.ajax({url:M.cfg.wwwroot+"/mod/intebchat/api/thread.php?thread_id="+chatData[instanceId].threadId,type:"GET",dataType:"json",success:function(data){for(var i=0;i<data.length;i++)addToChatLog("user"===data[i].role?"user":"bot",data[i].message,instanceId)},error:function(){chatData[instanceId]={},localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))}}):chatData[instanceId]={}:chatData={[instanceId]:{}},localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))),updateTokenUI(),$(document).on("keyup",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){13!==e.which||e.shiftKey||""===e.target.value||(e.preventDefault(),tokenInfo.exceeded||(addToChatLog("user",e.target.value,instanceId),createCompletion(e.target.value,instanceId,api_type),e.target.value=""))})),$(document).on("click",'.mod_intebchat[data-instance-id="'+instanceId+'"] #go',(function(e){var input=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input');""===input.val()||tokenInfo.exceeded||(addToChatLog("user",input.val(),instanceId),createCompletion(input.val(),instanceId,api_type),input.val(""))})),$(document).on("click",'.mod_intebchat[data-instance-id="'+instanceId+'"] #refresh',(function(e){clearHistory(instanceId)})),$(document).on("input",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){this.style.height="auto",this.style.height=this.scrollHeight+"px"}));Str.get_strings([{key:"askaquestion",component:"mod_intebchat"},{key:"erroroccurred",component:"mod_intebchat"}]).then((function(results){questionString=results[0],errorString=results[1]})),tokenInfo.enabled&&setInterval(checkTokenReset,6e4)}}}));

//# sourceMappingURL=lib.min.js.map