/**
 * Main JavaScript for INTEB Chat module
 *
 * @module     mod_intebchat/lib
 * @copyright  2025 Alonso Arias <soporte@ingeweb.co>
 * @copyright  Based on work by 2022 Bryce Yoder <me@bryceyoder.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_intebchat/lib",["jquery","core/ajax","core/str","core/notification"],(function($,Ajax,Str,Notification){var questionString="Ask a question...",errorString="An error occurred! Please try again later.",chatData={},addToChatLog=function(type,message,instanceId){var messageContainer=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log'),messageElem=$("<div></div>").addClass("openai_message").addClass(type),messageText=$("<span></span>").html(message);messageElem.append(messageText),messageContainer.append(messageElem),messageText.width()&&messageElem.css("width",messageText.width()+40+"px"),messageContainer.scrollTop(messageContainer[0].scrollHeight)},clearHistory=function(instanceId){(chatData=localStorage.getItem("mod_intebchat_data"))&&(chatData=JSON.parse(chatData))[instanceId]&&(chatData[instanceId]={},localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').html("")},createCompletion=function(message,instanceId,api_type){var threadId=null;"assistant"===api_type&&((chatData=localStorage.getItem("mod_intebchat_data"))?(chatData=JSON.parse(chatData))[instanceId]&&(threadId=chatData[instanceId].threadId||null):chatData={[instanceId]:{}});var history=buildTranscript(instanceId);$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').addClass("disabled"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').removeClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",questionString),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').blur(),addToChatLog("bot loading","...",instanceId),$.ajax({url:M.cfg.wwwroot+"/mod/intebchat/api/completion.php",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({message:message,history:history,instanceId:instanceId,threadId:threadId}),success:function(data){$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').children().last().remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled"),data.message?(addToChatLog("bot",data.message,instanceId),data.thread_id&&(chatData[instanceId].threadId=data.thread_id,localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData)))):data.error&&addToChatLog("bot",data.error.message,instanceId),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').focus()},error:function(xhr,status,error){$('.mod_intebchat[data-instance-id="'+instanceId+'"] #intebchat_log').children().last().remove(),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #control_bar').removeClass("disabled"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').addClass("error"),$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input').attr("placeholder",errorString)}})},buildTranscript=function(instanceId){var transcript=[];return $('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').each((function(index,element){if(index!==$('.mod_intebchat[data-instance-id="'+instanceId+'"] .openai_message').length-1){var user=userName;$(element).hasClass("bot")&&(user=assistantName),transcript.push({user:user,message:$(element).text()})}})),transcript};return{init:function(data){var instanceId=data.instanceId,api_type=data.api_type,persistConvo=data.persistConvo;"assistant"===api_type&&((chatData=localStorage.getItem("mod_intebchat_data"))?(chatData=JSON.parse(chatData))[instanceId]&&chatData[instanceId].threadId&&"1"===persistConvo?$.ajax({url:M.cfg.wwwroot+"/mod/intebchat/api/thread.php?thread_id="+chatData[instanceId].threadId,type:"GET",dataType:"json",success:function(data){for(var i=0;i<data.length;i++)addToChatLog("user"===data[i].role?"user":"bot",data[i].message,instanceId)},error:function(){chatData[instanceId]={},localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))}}):chatData[instanceId]={}:chatData={[instanceId]:{}},localStorage.setItem("mod_intebchat_data",JSON.stringify(chatData))),$(document).on("keyup",'.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input',(function(e){13===e.which&&""!==e.target.value&&(addToChatLog("user",e.target.value,instanceId),createCompletion(e.target.value,instanceId,api_type),e.target.value="")})),$(document).on("click",'.mod_intebchat[data-instance-id="'+instanceId+'"] #go',(function(e){var input=$('.mod_intebchat[data-instance-id="'+instanceId+'"] #openai_input');""!==input.val()&&(addToChatLog("user",input.val(),instanceId),createCompletion(input.val(),instanceId,api_type),input.val(""))})),$(document).on("click",'.mod_intebchat[data-instance-id="'+instanceId+'"] #refresh',(function(e){clearHistory(instanceId)}));Str.get_strings([{key:"askaquestion",component:"mod_intebchat"},{key:"erroroccurred",component:"mod_intebchat"}]).then((function(results){questionString=results[0],errorString=results[1]}))}}}));

//# sourceMappingURL=lib.min.js.map